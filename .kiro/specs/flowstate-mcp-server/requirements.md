# Requirements Document

## Introduction

The FlowState MCP Server extends the existing FlowState Dashboard by providing a Model Context Protocol (MCP) server that exposes productivity insights through standardized tools. The server loads correlation data from the existing FlowState pipeline and provides five analytical tools for querying productivity patterns, plus a resource endpoint for dashboard access. This enables AI assistants and other MCP clients to programmatically access FlowState insights for productivity analysis and recommendations.

## Glossary

- **MCP Server**: A Model Context Protocol server that exposes tools and resources to MCP clients
- **FastMCP**: A Python framework for building MCP servers with simplified tool registration
- **FlowState Tools**: Five analytical functions exposed via MCP: get_best_hours, get_flow_state_pattern, analyze_productivity, get_music_impact, predict_commits
- **Correlation Data**: The JSON data generated by the existing FlowState pipeline containing timeline, music correlation, and insights
- **Productivity Insights**: Analytical results derived from YouTube music, video consumption, and GitHub commit patterns
- **MCP Client**: Any application that connects to MCP servers to access tools and resources (e.g., AI assistants, IDEs)
- **Resource Endpoint**: An MCP resource that provides access to external content, in this case the FlowState dashboard URL
- **STDIO Transport**: Standard input/output communication protocol used by MCP servers

## Requirements

### Requirement 1

**User Story:** As an MCP client, I want to discover optimal coding hours from FlowState data, so that I can recommend the best times for productive coding sessions.

#### Acceptance Criteria

1. WHEN the get_best_hours tool is called, THE MCP Server SHALL load correlation data from public/correlations.json
2. WHEN analyzing hourly patterns, THE MCP Server SHALL identify the top 3 hours with highest average commit counts
3. WHEN formatting the response, THE MCP Server SHALL return a JSON object with best_hours array containing hour, avg_commits, and day_pattern fields
4. WHEN no data is available, THE MCP Server SHALL return an error message indicating data unavailability
5. WHEN correlation data is malformed, THE MCP Server SHALL handle the error gracefully and return a descriptive error message

### Requirement 2

**User Story:** As an MCP client, I want to identify the optimal flow state pattern from FlowState data, so that I can recommend the best combination of music and video consumption for maximum productivity.

#### Acceptance Criteria

1. WHEN the get_flow_state_pattern tool is called, THE MCP Server SHALL analyze music correlation data to find the optimal productivity pattern
2. WHEN determining the best pattern, THE MCP Server SHALL identify the category with highest average commits per day
3. WHEN calculating pattern effectiveness, THE MCP Server SHALL compute the percentage boost compared to baseline (no music/videos)
4. WHEN formatting the response, THE MCP Server SHALL return a JSON object with pattern, avg_commits, boost_percentage, and recommendation fields
5. WHEN insufficient data exists for analysis, THE MCP Server SHALL return a message indicating more data is needed

### Requirement 3

**User Story:** As an MCP client, I want to analyze productivity for a specific date from FlowState data, so that I can provide detailed insights about coding performance on that day.

#### Acceptance Criteria

1. WHEN the analyze_productivity tool is called with a date parameter, THE MCP Server SHALL validate the date format (YYYY-MM-DD)
2. WHEN the date is valid, THE MCP Server SHALL search timeline data for the specified date
3. WHEN the date is found, THE MCP Server SHALL return a JSON object with date, music_count, video_count, commit_count, and productivity_score fields
4. WHEN the date is not found in timeline data, THE MCP Server SHALL return a message indicating no data available for that date
5. WHEN the date format is invalid, THE MCP Server SHALL return an error message with the expected format

### Requirement 4

**User Story:** As an MCP client, I want to understand music impact on coding productivity from FlowState data, so that I can recommend whether background music improves coding performance.

#### Acceptance Criteria

1. WHEN the get_music_impact tool is called, THE MCP Server SHALL analyze the correlation between music consumption and commit counts
2. WHEN calculating music impact, THE MCP Server SHALL compare average commits on days with music versus days without music
3. WHEN determining significance, THE MCP Server SHALL calculate the percentage improvement and sample sizes for both groups
4. WHEN formatting the response, THE MCP Server SHALL return a JSON object with music_boost_percentage, days_with_music, days_without_music, and recommendation fields
5. WHEN insufficient data exists for meaningful analysis, THE MCP Server SHALL return a message indicating more data collection is needed

### Requirement 5

**User Story:** As an MCP client, I want to predict commit counts based on music and video consumption from FlowState data, so that I can forecast productivity based on planned activities.

#### Acceptance Criteria

1. WHEN the predict_commits tool is called with music_hours and video_minutes parameters, THE MCP Server SHALL validate that both parameters are non-negative numbers
2. WHEN parameters are valid, THE MCP Server SHALL use correlation data to calculate predicted commit count based on historical patterns
3. WHEN making predictions, THE MCP Server SHALL apply learned coefficients from music and video impact analysis
4. WHEN formatting the response, THE MCP Server SHALL return a JSON object with predicted_commits, confidence_level, and factors_considered fields
5. WHEN parameters are invalid, THE MCP Server SHALL return an error message specifying the valid parameter ranges

### Requirement 6

**User Story:** As an MCP client, I want to access the FlowState dashboard through an MCP resource, so that I can provide direct links to the visual dashboard for users.

#### Acceptance Criteria

1. WHEN MCP clients query available resources, THE MCP Server SHALL expose a resource named "flowstate://dashboard"
2. WHEN the dashboard resource is accessed, THE MCP Server SHALL return the S3 URL where the FlowState dashboard is deployed
3. WHEN the S3 URL is not configured, THE MCP Server SHALL return a localhost development URL as fallback
4. WHEN resource metadata is requested, THE MCP Server SHALL provide description, content type, and last modified information
5. WHEN the resource is unavailable, THE MCP Server SHALL return an appropriate error message

### Requirement 7

**User Story:** As a developer, I want the MCP server to handle errors gracefully and provide meaningful error messages, so that MCP clients can respond appropriately to failures.

#### Acceptance Criteria

1. WHEN correlation data file is missing, THE MCP Server SHALL return an error message instructing to run the FlowState data pipeline first
2. WHEN JSON parsing fails, THE MCP Server SHALL return an error message indicating corrupted data and suggesting pipeline re-run
3. WHEN tool parameters are missing or invalid, THE MCP Server SHALL return specific error messages describing the expected parameters
4. WHEN unexpected exceptions occur, THE MCP Server SHALL log the error and return a generic error message without exposing internal details
5. WHEN the server starts successfully, THE MCP Server SHALL log initialization status and available tools

### Requirement 8

**User Story:** As a system administrator, I want the MCP server to be easily installable and runnable, so that it can be integrated into existing MCP client configurations.

#### Acceptance Criteria

1. WHEN installing dependencies, THE MCP Server SHALL require only mcp[cli]>=0.9.0 in addition to existing FlowState requirements
2. WHEN the server is executed, THE MCP Server SHALL run with STDIO transport using mcp.run(transport='stdio')
3. WHEN the server starts, THE MCP Server SHALL register all five tools with FastMCP framework
4. WHEN configuration is needed, THE MCP Server SHALL read environment variables for optional S3 dashboard URL
5. WHEN the server is added to MCP client configs, THE MCP Server SHALL be executable via python scripts/mcp_server.py

### Requirement 9

**User Story:** As a developer, I want comprehensive documentation for the MCP server integration, so that I can understand how to configure and use the FlowState MCP server.

#### Acceptance Criteria

1. WHEN updating the README, THE MCP Server documentation SHALL include an "MCP Server" section with setup instructions
2. WHEN documenting tool usage, THE MCP Server documentation SHALL provide examples of each tool call with expected parameters and responses
3. WHEN explaining integration, THE MCP Server documentation SHALL show how to add the server to MCP client configurations
4. WHEN describing dependencies, THE MCP Server documentation SHALL list the additional requirement (mcp[cli]>=0.9.0)
5. WHEN providing troubleshooting, THE MCP Server documentation SHALL include common error scenarios and solutions

### Requirement 10

**User Story:** As a developer, I want the MCP server implementation to follow Python best practices and maintain code quality, so that it is maintainable and reliable.

#### Acceptance Criteria

1. WHEN implementing the server, THE MCP Server SHALL use type hints for all function parameters and return values
2. WHEN handling data, THE MCP Server SHALL validate input parameters and sanitize outputs
3. WHEN structuring code, THE MCP Server SHALL organize functions logically with clear separation of concerns
4. WHEN implementing error handling, THE MCP Server SHALL use try-except blocks around all external operations (file I/O, JSON parsing)
5. WHEN formatting responses, THE MCP Server SHALL return consistent JSON structures with appropriate HTTP-like status information